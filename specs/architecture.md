# Architecture â€” diffy

## ì‹œìŠ¤í…œ ê°œìš”

diffyëŠ” layered MVC íŒ¨í„´ê³¼ ì´ë²¤íŠ¸ ê¸°ë°˜ TUIë¥¼ ê²°í•©í•œ Rust ì• í”Œë¦¬ì¼€ì´ì…˜ì…ë‹ˆë‹¤.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   main.rs (ë¼ìš°í„°)                   â”‚
â”‚    --restore / pipe mode / CLI mode ë¶„ê¸° ì²˜ë¦¬       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ git.rs  â”‚  parse.rs    â”‚  config.rs   â”‚  cli.rs    â”‚
â”‚ Git CLI â”‚  Diff íŒŒì„œ   â”‚  ì„¤ì • ë¡œë“œ    â”‚  ì¸ì íŒŒì‹±  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    model.rs                         â”‚
â”‚         Diff / FileDiff / Hunk / ReviewStatus       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     tui/                            â”‚
â”‚   mod.rs (ë£¨í”„) â”‚ state.rs â”‚ input.rs â”‚ render.rs   â”‚
â”‚                 â”‚          â”‚          â”‚ highlight.rsâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  output.rs     â”‚  hook.rs        â”‚  revert.rs      â”‚
â”‚  Diff/JSON ì¶œë ¥â”‚  í”¼ë“œë°± ìƒì„±     â”‚  ë°±ì—…/ë³µì›       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ëª¨ë“ˆ ì˜ì¡´ ê´€ê³„

```
main
â”œâ”€â”€ cli         (Cli êµ¬ì¡°ì²´)
â”œâ”€â”€ config      (Config ë¡œë“œ)
â”œâ”€â”€ git         (git diff ì‹¤í–‰)
â”œâ”€â”€ parse       (unified diff â†’ Diff)
â”œâ”€â”€ model       (Diff, FileDiff, Hunk â€” ëª¨ë“  ëª¨ë“ˆì´ ê³µìœ )
â”œâ”€â”€ tui
â”‚   â”œâ”€â”€ state   (AppState, AppMode)
â”‚   â”œâ”€â”€ input   (Action, handle_key, apply_action)
â”‚   â”œâ”€â”€ render  (UI ë Œë”ë§)
â”‚   â””â”€â”€ highlight (êµ¬ë¬¸ ê°•ì¡°)
â”œâ”€â”€ output      (diff/JSON ì¶œë ¥)
â”œâ”€â”€ hook        (Claude í”¼ë“œë°±)
â”œâ”€â”€ revert      (ë°±ì—…/ì—­íŒ¨ì¹˜)
â””â”€â”€ tty         (TTY ê°ì§€)
```

## ì‹¤í–‰ íë¦„

### 1. ì—”íŠ¸ë¦¬í¬ì¸íŠ¸ (main.rs)

```
main() â†’ run() â†’ ì„¸ ê°€ì§€ ë¶„ê¸°:
  1. --restore      â†’ revert::restore() â†’ exit
  2. stdin is pipe  â†’ run_pipe_mode()
  3. stdin is TTY   â†’ run_cli_mode()
```

### 2. CLI ëª¨ë“œ ìƒì„¸

```
run_cli_mode()
  â”œâ”€ git::is_git_repo()         // git ì €ì¥ì†Œ í™•ì¸
  â”œâ”€ git::has_commits()         // ì»¤ë°‹ ì¡´ì¬ í™•ì¸
  â”œâ”€ resolve_diff_mode()        // Unstaged/Staged/Head/Ref ê²°ì •
  â”œâ”€ git::git_diff()            // git diff ì‹¤í–‰
  â”œâ”€ parse::parse_diff()        // í…ìŠ¤íŠ¸ â†’ Diff êµ¬ì¡°ì²´
  â”œâ”€ [--apply] revert::backup() // git stashë¡œ ë°±ì—…
  â”œâ”€ config::load()             // ì‚¬ìš©ì ì„¤ì • ë¡œë“œ
  â”œâ”€ tui::run(diff, config)     // TUI ì‹¤í–‰ â†’ ë¦¬ë·°ëœ Diff ë°˜í™˜
  â”œâ”€ [--apply] reverse patch    // rejected hunk ë˜ëŒë¦¬ê¸°
  â”œâ”€ [--hook-mode] feedback     // stderrë¡œ í”¼ë“œë°± ì¶œë ¥
  â””â”€ write_output()             // stdoutìœ¼ë¡œ diff/JSON ì¶œë ¥
```

### 3. TUI ì´ë²¤íŠ¸ ë£¨í”„ (tui/mod.rs)

```
tui::run()
  â”œâ”€ enable_raw_mode()
  â”œâ”€ enter_alternate_screen()
  â”œâ”€ Terminal::new(CrosstermBackend(/dev/tty))
  â”œâ”€ CleanupGuard ìƒì„± (RAII)
  â””â”€ run_loop()
       loop {
         1. viewport_height ê°±ì‹ 
         2. ë§ˆìš°ìŠ¤ ìº¡ì²˜ í† ê¸€
         3. terminal.draw(render::render)
         4. crossterm::event::read()
         5. [CommentEdit/Search] â†’ ë¬¸ì ì¸í„°ì…‰íŠ¸
         6. input::handle_key() â†’ Action
         7. input::apply_action(action, state)
         8. [CancelPendingG] â†’ Normal ëª¨ë“œ ì¬ë””ìŠ¤íŒ¨ì¹˜
         9. should_quit í™•ì¸ â†’ break
       }
```

## ë””ìì¸ íŒ¨í„´

### State Machine íŒ¨í„´ (AppMode)

```
Normal â”€â”€â”€ '?' â”€â”€â”€â†’ Help â”€â”€â”€ any key â”€â”€â”€â†’ Normal
  â”‚
  â”œâ”€â”€ 'g' â”€â”€â”€â†’ PendingG â”€â”€â”€ 'g' â”€â”€â”€â†’ Normal (first hunk)
  â”‚                      â””â”€â”€ other â”€â”€â†’ Normal (cancel)
  â”œâ”€â”€ '/' â”€â”€â”€â†’ Search â”€â”€â”€ Enter â”€â”€â”€â†’ Normal (execute)
  â”‚                    â””â”€â”€ Esc â”€â”€â”€â”€â†’ Normal (cancel)
  â”œâ”€â”€ 'c' â”€â”€â”€â†’ CommentEdit â”€â”€â”€ Enter â”€â”€â†’ Normal (save)
  â”‚                          â””â”€â”€ Esc â”€â”€â”€â†’ Normal (cancel)
  â”œâ”€â”€ 's' â”€â”€â”€â†’ Stats â”€â”€â”€ s/Esc/q â”€â”€â†’ Normal
  â”‚                   â””â”€â”€ Enter â”€â”€â”€â”€â†’ Normal (navigate)
  â””â”€â”€ 'q' â”€â”€â”€â†’ ConfirmQuit â”€â”€â”€ y/Enter â”€â”€â†’ quit
                             â””â”€â”€ n/Esc â”€â”€â”€â†’ Normal
```

### Command íŒ¨í„´ (Action enum)

í‚¤ ì…ë ¥ì´ `Action` enumìœ¼ë¡œ ë³€í™˜ë˜ê³ , `apply_action()`ì´ ìƒíƒœë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.

```
KeyEvent â†’ handle_key(key, state) â†’ Action â†’ apply_action(action, state) â†’ ìƒíƒœ ë³€ê²½
```

45ê°€ì§€ Action: NextHunk, PrevHunk, Accept, Reject, Undo, ToggleFileTree, EnterSearch, ...

### Guard íŒ¨í„´ (CleanupGuard)

```rust
struct CleanupGuard;
impl Drop for CleanupGuard {
    fn drop(&mut self) {
        // í„°ë¯¸ë„ ìƒíƒœ ë³µì› (íŒ¨ë‹‰ ì‹œì—ë„ ì‹¤í–‰)
        disable_raw_mode();
        leave_alternate_screen();
        disable_mouse_capture();
    }
}
```

## ë Œë”ë§ ë ˆì´ì•„ì›ƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ File Bar: path/to/file.rs  +15 -3  [2/5]       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ File Tree    â”‚ Diff View                        â”‚
â”‚ (30 cols)    â”‚                                  â”‚
â”‚              â”‚ @@ -10,5 +10,6 @@ fn main()     â”‚
â”‚ âœ“ main.rs   â”‚  10â”‚  use std::io;               â”‚
â”‚ ~ lib.rs    â”‚  11â”‚- old line                    â”‚
â”‚ âœ— test.rs   â”‚  12â”‚+ new line                    â”‚
â”‚ Â· config.rs â”‚  13â”‚  context                     â”‚
â”‚              â”‚                                  â”‚
â”‚              â”‚ ğŸ’¬ comment: fix error handling    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Status: [3/10 reviewed] a:accept r:reject q:quitâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Virtual Document ëª¨ë¸

- í˜„ì¬ hunkë§Œ í™•ì¥, ë‚˜ë¨¸ì§€ëŠ” í—¤ë” 1ì¤„ë¡œ ì¶•ì†Œ
- viewport_offset + viewport_heightë¡œ ìŠ¬ë¼ì´ì‹±
- `ensure_visible()`ë¡œ í˜„ì¬ hunkê°€ í•­ìƒ ë³´ì´ë„ë¡ ìŠ¤í¬ë¡¤

### Side-by-Side ë·°

- í„°ë¯¸ë„ í­ â‰¥ 100ì¼ ë•Œ ì‚¬ìš© ê°€ëŠ¥
- ì‚­ì œ/ì¶”ê°€ ë¼ì¸ì„ ë²„í¼ë§í•˜ì—¬ ìŒìœ¼ë¡œ ë§¤ì¹­
- Context ë¼ì¸ì—ì„œ ë²„í¼ í”ŒëŸ¬ì‹œ

## ì—ëŸ¬ ì²˜ë¦¬

- `anyhow::Result<T>` ì¼ê´€ ì‚¬ìš©
- `.context("ì„¤ëª…")` ìœ¼ë¡œ ì—ëŸ¬ ì»¨í…ìŠ¤íŠ¸ ì¶”ê°€
- `main()`ì—ì„œ ìµœì¢… ì—ëŸ¬ ì¶œë ¥ â†’ `process::exit(1)`
- TUIëŠ” `CleanupGuard`ë¡œ íŒ¨ë‹‰ ì•ˆì „ì„± ë³´ì¥

## ì„±ëŠ¥ íŠ¹ì„±

| ì˜ì—­ | ì „ëµ | ë¹„ê³  |
|------|------|------|
| ë Œë”ë§ | ë§¤ í”„ë ˆì„ virtual doc ì¬êµ¬ì¶• | ëŒ€ë¶€ë¶„ì˜ diffì—ì„œ ì¶©ë¶„ |
| ê²€ìƒ‰ | ì „ì²´ ë¼ì¸ ì„ í˜• ìŠ¤ìº” | ê²€ìƒ‰ ì‹¤í–‰ ì‹œ 1íšŒ |
| ë·°í¬íŠ¸ | ë³´ì´ëŠ” ì˜ì—­ë§Œ ìŠ¬ë¼ì´ì‹± | íš¨ìœ¨ì  |
| Hunk ì¶•ì†Œ | ë¹„í˜„ì¬ hunkëŠ” í—¤ë”ë§Œ í‘œì‹œ | ë Œë”ë§ ìµœì í™” |
| í”¼ë“œë°± | 10KB íŠ¸ëŸ°ì¼€ì´ì…˜ | Claude ì»¨í…ìŠ¤íŠ¸ ì ˆì•½ |
| ë°±ì—… | ìµœëŒ€ 10ê°œ ìœ ì§€ + ìë™ ì •ë¦¬ | ë””ìŠ¤í¬ ê´€ë¦¬ |
